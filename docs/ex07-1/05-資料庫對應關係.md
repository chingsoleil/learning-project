# 資料庫對應關係

## 現有資料庫結構

### 7個資料表

1. **InstrumentCategory** - 量表分類主檔（36筆）
2. **TraitCategory** - 特質面向分類主檔（246筆）
3. **QuestionBank** - 題庫主檔（3,805筆）
4. **TestPaper** - 測卷主檔（5筆）
5. **TestPaperDetail** - 測卷明細檔（250筆，每卷50題）
6. **TestSession** - 受測主檔（待建立）
7. **TestAnswer** - 受測作答明細檔（待建立）

---

## MOCKUP 頁面與資料表對應

### 使用者端頁面

#### 1. 首頁 (Home.vue)
**對應資料表**: `TestPaper`
- 顯示所有啟用的測卷（`IsActive = 1`）
- 欄位對應：
  - `Name` → 測驗卡片標題
  - `Description` → 測驗說明
  - `TotalQuestions` → 題數顯示
  - `TimeLimit` → 時間顯示（需計算）

**API 需求**:
```
GET /api/testpapers?isActive=true
```

#### 2. 測驗介紹頁 (TestIntro.vue)
**對應資料表**: `TestPaper`
- 顯示單一測卷資訊
- 欄位對應：
  - `Name` → 測驗名稱
  - `Description` → 測驗說明
  - `TotalQuestions` → 題數
  - `TimeLimit` → 時間限制
  - `ResponseType` → 作答方式說明

**API 需求**:
```
GET /api/testpapers/{id}
```

#### 3. 個人資訊填寫頁 (UserInfo.vue)
**對應資料表**: `TestSession`（建立新記錄）
- 表單欄位對應：
  - `TestTakerName` ← 姓名
  - `Gender` ← 性別
  - `Phone` ← 電話
  - `Email` ← Email
  - `BirthDate` ← 生日（需從年齡計算，或新增 Age 欄位）
  - `TestPaperId` ← 當前測卷ID
  - `Status` ← 'NotStarted'

**API 需求**:
```
POST /api/testsessions
Body: {
  testPaperId: number,
  testTakerName: string,
  gender: string,
  phone?: string,
  email?: string,
  birthDate?: date
}
```

#### 4. 答題頁 (Questions.vue)
**對應資料表**: 
- `TestPaperDetail` - 取得題目列表
- `QuestionBank` - 取得題目內容
- `TestAnswer` - 儲存作答記錄
- `TestSession` - 更新狀態

**題目載入**:
```
GET /api/testpapers/{id}/questions
→ 回傳 TestPaperDetail + QuestionBank 的 JOIN 結果
→ 依 QuestionOrder 排序
```

**作答儲存**:
```
POST /api/testanswers
Body: {
  testSessionId: number,
  testPaperDetailId: number,
  answerValue: number
}
```

**狀態更新**:
```
PATCH /api/testsessions/{id}
Body: {
  status: 'InProgress' | 'Completed',
  startedAt?: datetime,
  completedAt?: datetime
}
```

#### 5. 測驗結果頁 (TestResult.vue)
**對應資料表**:
- `TestSession` - 測驗基本資訊
- `TestAnswer` - 作答記錄
- `QuestionBank` - 題目資訊（計分鍵）
- `TraitCategory` - 特質資訊

**資料載入**:
```
GET /api/testsessions/{id}/result
→ 回傳：
  - TestSession 資訊
  - 各特質分數（動態計算）
  - 百分位（需統計計算）
```

**分數計算邏輯**:
1. 取得 TestSession 的所有 TestAnswer
2. 透過 TestPaperDetail 取得對應的 QuestionBank
3. 依 QuestionBank.ScoringKey 處理正反向計分
4. 依 QuestionBank.TraitCategoryId 分組
5. 計算各特質的原始分數
6. 計算百分位（需統計資料）

#### 6. 詳細報告頁 (DetailedReport.vue)
**對應資料表**:
- `TestSession` - 測驗資訊
- `TestAnswer` - 作答記錄
- `TraitCategory` - 特質詳細說明
- `Consultation` - 諮詢記錄（需新增）

**資料載入**:
```
GET /api/testsessions/{id}/detailed-report
→ 回傳：
  - 各特質詳細分析
  - 職涯建議（需實作邏輯或資料表）
```

**諮詢提交**:
```
POST /api/consultations
Body: {
  testSessionId: number,
  title: string,
  category: string,
  content: string,
  contactMethod: string,
  availableTimes: string[]
}
```

#### 7. 歷史記錄查詢頁 (TestHistory.vue)
**對應資料表**: `TestSession`
- 透過 Email + Phone 查詢

**API 需求**:
```
GET /api/testsessions?email={email}&phone={phone}
→ 回傳該使用者的所有 TestSession
```

---

### 管理系統頁面

#### 1. 儀表板 (admin/Dashboard.vue)
**對應資料表**:
- `TestSession` - 統計資料
- `Consultation` - 諮詢統計

**API 需求**:
```
GET /api/admin/dashboard/stats
→ 回傳：
  - 總測驗數
  - 完成率
  - 活躍使用者數
  - 諮詢請求數
  - 近30天趨勢
  - 測驗類型分布
  - 年齡分布
  - 性別分布
  - 最新活動
```

#### 2. 測驗管理頁 (admin/TestManagement.vue)
**對應資料表**: `TestPaper`

**API 需求**:
```
GET /api/admin/testpapers
POST /api/admin/testpapers
PUT /api/admin/testpapers/{id}
DELETE /api/admin/testpapers/{id}
PATCH /api/admin/testpapers/{id}/status
```

#### 3. 題目管理頁 (admin/QuestionManagement.vue)
**對應資料表**: 
- `TestPaperDetail` - 測卷題目列表
- `QuestionBank` - 題目內容
- `TraitCategory` - 特質資訊
- `InstrumentCategory` - 量表資訊

**API 需求**:
```
GET /api/admin/testpapers/{id}/questions
POST /api/admin/testpapers/{id}/questions
PUT /api/admin/testpaperdetails/{id}
DELETE /api/admin/testpaperdetails/{id}
```

#### 4. 使用者管理頁 (admin/UserManagement.vue)
**對應資料表**: `TestSession`（需 GROUP BY 使用者）

**API 需求**:
```
GET /api/admin/users
→ 回傳：
  - 使用者基本資訊（從 TestSession 彙總）
  - 測驗次數
  - 最後測驗時間
```

#### 5. 諮詢管理頁 (admin/ConsultationManagement.vue)
**對應資料表**: `Consultation`（需新增）

**API 需求**:
```
GET /api/admin/consultations
PUT /api/admin/consultations/{id}/status
POST /api/admin/consultations/{id}/reply
```

#### 6. 報告管理頁 (admin/ReportManagement.vue)
**對應資料表**: `TestSession` + `TestAnswer`

**API 需求**:
```
GET /api/admin/reports
→ 回傳報告統計資料
```

---

## 資料關聯圖

```
TestPaper (測卷)
  ├─ TestPaperDetail (測卷明細)
  │    └─ QuestionBank (題目)
  │         ├─ InstrumentCategory (量表)
  │         └─ TraitCategory (特質)
  │
  └─ TestSession (受測記錄)
       ├─ TestAnswer (作答記錄)
       │    └─ TestPaperDetail (題目資訊)
       │
       └─ Consultation (諮詢記錄)
```

---

## 資料流程

### 測驗流程資料流

```
1. 使用者選擇測卷
   → GET /api/testpapers/{id}
   → 顯示測驗資訊

2. 填寫個人資訊
   → POST /api/testsessions
   → 建立 TestSession (Status: NotStarted)
   → 回傳 SessionId

3. 開始作答
   → GET /api/testpapers/{id}/questions
   → 載入題目列表
   → PATCH /api/testsessions/{id} (Status: InProgress)

4. 每題作答
   → POST /api/testanswers
   → 儲存作答記錄

5. 完成測驗
   → PATCH /api/testsessions/{id} (Status: Completed)
   → GET /api/testsessions/{id}/result
   → 計算並顯示結果

6. 查看詳細報告
   → GET /api/testsessions/{id}/detailed-report
   → 顯示詳細分析

7. 提交諮詢
   → POST /api/consultations
   → 建立諮詢記錄
```

---

## 資料轉換

### 前端 → 後端（API Request）

| 前端欄位 | 後端欄位 | 資料表 | 轉換說明 |
|---------|---------|--------|---------|
| testTakerName | TestTakerName | TestSession | 直接對應 |
| gender | Gender | TestSession | 直接對應 |
| age | BirthDate | TestSession | 需計算（或新增 Age 欄位） |
| phone | Phone | TestSession | 直接對應 |
| email | Email | TestSession | 直接對應 |
| questionId | TestPaperDetailId | TestAnswer | 需轉換 |
| answerValue | AnswerValue | TestAnswer | 直接對應 |

### 後端 → 前端（API Response）

| 後端欄位 | 前端欄位 | 資料表 | 轉換說明 |
|---------|---------|--------|---------|
| Name | name | TestPaper | 直接對應 |
| TotalQuestions | totalQuestions | TestPaper | 直接對應 |
| TextZh | text | QuestionBank | 直接對應 |
| NameZh | nameZh | TraitCategory | 直接對應 |
| Score | score | 計算結果 | 需計算 |

---

## 命名規範

### 資料庫（PascalCase）
- 表名：`TestPaper`, `TestSession`
- 欄位名：`TestTakerName`, `CreatedAt`

### API（camelCase）
- 路徑：`/api/testpapers`, `/api/testsessions`
- 欄位：`testTakerName`, `createdAt`

### 前端（camelCase）
- 變數：`testTakerName`, `createdAt`
- 組件：`TestResult`, `UserInfo`

---

## 索引建議

### 查詢優化索引

```sql
-- TestSession 查詢優化
CREATE INDEX IX_TestSession_Email_Phone 
ON TestSession(Email, Phone);

CREATE INDEX IX_TestSession_Status_CreatedAt 
ON TestSession(Status, CreatedAt);

-- TestAnswer 查詢優化
CREATE INDEX IX_TestAnswer_SessionId_DetailId 
ON TestAnswer(TestSessionId, TestPaperDetailId);

-- TestPaperDetail 查詢優化
CREATE INDEX IX_TestPaperDetail_PaperId_Order 
ON TestPaperDetail(TestPaperId, QuestionOrder);
```

---

## 總結

### 對應完整性
- ✅ **核心功能對應完整**：所有主要功能都有對應資料表
- ⚠️ **部分功能需新增資料表**：諮詢功能需新增 Consultation 表
- ⚠️ **部分欄位需擴充**：TestSession 可能需要 Age 欄位

### 實作重點
1. **API 設計**：需設計完整的 RESTful API
2. **資料轉換**：前後端命名規範轉換
3. **查詢優化**：建立適當的索引
4. **分數計算**：實作動態分數計算邏輯

