# 資料庫欠缺項目

## 現有資料庫結構回顧

### 已建立的 7 個資料表
1. ✅ InstrumentCategory - 量表分類
2. ✅ TraitCategory - 特質面向
3. ✅ QuestionBank - 題庫
4. ✅ TestPaper - 測卷
5. ✅ TestPaperDetail - 測卷明細
6. ✅ TestSession - 受測記錄
7. ✅ TestAnswer - 作答記錄

---

## 欠缺的資料表

### 1. Consultation（諮詢記錄表）🔴 必須新增

**需求來源**: 
- MOCKUP 詳細報告頁有諮詢表單
- 管理系統有諮詢管理頁

**建議結構**:
```sql
CREATE TABLE dbo.Consultation (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    TestSessionId INT NULL,                    -- 關聯的測驗記錄（可選）
    Title NVARCHAR(200) NOT NULL,               -- 諮詢標題
    Category NVARCHAR(50) NOT NULL,             -- 諮詢類別
    Content NVARCHAR(MAX) NOT NULL,             -- 諮詢內容
    ContactMethod NVARCHAR(20) NOT NULL,        -- 聯絡方式：Email, Phone, Line
    ContactInfo NVARCHAR(200) NULL,             -- 聯絡資訊（Email/電話/Line ID）
    AvailableTimes NVARCHAR(500) NULL,          -- 方便聯絡時間（JSON 或逗號分隔）
    Status NVARCHAR(20) NOT NULL DEFAULT 'Pending',  -- 狀態：Pending, InProgress, Completed, Cancelled
    ReplyContent NVARCHAR(MAX) NULL,           -- 回覆內容
    RepliedBy INT NULL,                         -- 回覆人員ID（未來擴充）
    RepliedAt DATETIME2 NULL,                   -- 回覆時間
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    UpdatedAt DATETIME2 NULL,
    
    CONSTRAINT FK_Consultation_TestSession 
        FOREIGN KEY (TestSessionId) 
        REFERENCES dbo.TestSession(Id)
);
```

**索引**:
```sql
CREATE INDEX IX_Consultation_Status ON Consultation(Status);
CREATE INDEX IX_Consultation_CreatedAt ON Consultation(CreatedAt);
CREATE INDEX IX_Consultation_TestSessionId ON Consultation(TestSessionId);
```

---

### 2. AdminUser（管理員表）🟡 建議新增

**需求來源**:
- 管理系統需要登入功能
- 目前 MOCKUP 使用 localStorage，實際應有資料表

**建議結構**:
```sql
CREATE TABLE dbo.AdminUser (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Username NVARCHAR(50) NOT NULL UNIQUE,      -- 帳號
    PasswordHash NVARCHAR(256) NOT NULL,        -- 密碼雜湊
    DisplayName NVARCHAR(100) NULL,             -- 顯示名稱
    Email NVARCHAR(100) NULL,                  -- Email
    Role NVARCHAR(20) NOT NULL DEFAULT 'Admin', -- 角色：Admin, SuperAdmin
    IsActive BIT NOT NULL DEFAULT 1,           -- 是否啟用
    LastLoginAt DATETIME2 NULL,                -- 最後登入時間
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    UpdatedAt DATETIME2 NULL
);
```

**索引**:
```sql
CREATE INDEX IX_AdminUser_Username ON AdminUser(Username);
CREATE INDEX IX_AdminUser_IsActive ON AdminUser(IsActive);
```

---

### 3. TestScore（測驗分數表）🟡 建議新增

**需求來源**:
- 測驗結果需要儲存計算後的分數
- 方便統計和查詢

**建議結構**:
```sql
CREATE TABLE dbo.TestScore (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    TestSessionId INT NOT NULL,                 -- 受測記錄ID
    TraitCategoryId INT NOT NULL,              -- 特質ID
    RawScore DECIMAL(10,2) NOT NULL,            -- 原始分數
    Percentile INT NULL,                        -- 百分位（0-100）
    Level NVARCHAR(20) NULL,                    -- 等級：Low, Medium, High
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    
    CONSTRAINT FK_TestScore_TestSession 
        FOREIGN KEY (TestSessionId) 
        REFERENCES dbo.TestSession(Id) 
        ON DELETE CASCADE,
    CONSTRAINT FK_TestScore_TraitCategory 
        FOREIGN KEY (TraitCategoryId) 
        REFERENCES dbo.TraitCategory(Id),
    CONSTRAINT UQ_TestScore_SessionTrait UNIQUE (TestSessionId, TraitCategoryId)
);
```

**索引**:
```sql
CREATE INDEX IX_TestScore_TestSessionId ON TestScore(TestSessionId);
CREATE INDEX IX_TestScore_TraitCategoryId ON TestScore(TraitCategoryId);
```

---

### 4. TestReport（測驗報告表）🔵 可選新增

**需求來源**:
- 儲存生成的報告內容
- 支援報告版本管理

**建議結構**:
```sql
CREATE TABLE dbo.TestReport (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    TestSessionId INT NOT NULL,                -- 受測記錄ID
    ReportType NVARCHAR(20) NOT NULL,          -- 報告類型：Summary, Detailed
    Content NVARCHAR(MAX) NULL,                -- 報告內容（JSON 或文字）
    GeneratedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    
    CONSTRAINT FK_TestReport_TestSession 
        FOREIGN KEY (TestSessionId) 
        REFERENCES dbo.TestSession(Id) 
        ON DELETE CASCADE
);
```

---

## 現有資料表需擴充的欄位

### 1. TestSession 表

#### 欠缺欄位

**Age（年齡）** 🟡 建議新增
- **原因**: MOCKUP 收集年齡，但資料表只有 BirthDate
- **問題**: 需要從 BirthDate 計算，或直接儲存 Age
- **建議**: 新增 `Age INT NULL` 欄位

```sql
ALTER TABLE dbo.TestSession
ADD Age INT NULL;
```

**SessionCode（測驗編號）** 🟡 建議新增
- **原因**: MOCKUP 顯示「Session #123456」，目前使用 Id
- **建議**: 新增唯一編號欄位，或使用 GUID

```sql
ALTER TABLE dbo.TestSession
ADD SessionCode NVARCHAR(50) NULL UNIQUE;

-- 或使用 GUID
ALTER TABLE dbo.TestSession
ADD SessionCode UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID();
```

**IPAddress（IP 位址）** 🔵 可選新增
- **原因**: 統計和分析用途
- **建議**: 新增 `IPAddress NVARCHAR(50) NULL`

**UserAgent（瀏覽器資訊）** 🔵 可選新增
- **原因**: 統計和分析用途
- **建議**: 新增 `UserAgent NVARCHAR(500) NULL`

---

### 2. TestPaper 表

#### 欠缺欄位

**Icon（圖示）** 🟡 建議新增
- **原因**: MOCKUP 測驗卡片有圖示（🎭、💼、💡）
- **建議**: 新增 `Icon NVARCHAR(10) NULL` 或 `IconUrl NVARCHAR(500) NULL`

**SortOrder（排序順序）** 🟡 建議新增
- **原因**: 首頁測驗列表需要排序
- **建議**: 新增 `SortOrder INT NULL DEFAULT 0`

**CoverImage（封面圖片）** 🔵 可選新增
- **原因**: 未來擴充使用
- **建議**: 新增 `CoverImageUrl NVARCHAR(500) NULL`

---

### 3. QuestionBank 表

#### 欠缺欄位

**Difficulty（難度）** 🔵 可選新增
- **原因**: 未來擴充使用
- **建議**: 新增 `Difficulty TINYINT NULL` (1-5)

**Category（題目分類）** 🔵 可選新增
- **原因**: 題目管理分類
- **建議**: 新增 `Category NVARCHAR(50) NULL`

---

## 欠缺的資料內容

### 1. 常模資料（Norm Data）🔴 必須建立

**需求來源**:
- 計算百分位需要常模資料
- 不同年齡、性別可能有不同常模

**建議方案**:

**方案 A: 建立常模資料表**
```sql
CREATE TABLE dbo.NormData (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    TraitCategoryId INT NOT NULL,
    Gender NVARCHAR(10) NULL,                  -- Male, Female, All
    AgeMin INT NULL,                           -- 年齡範圍
    AgeMax INT NULL,
    Mean DECIMAL(10,2) NOT NULL,               -- 平均分
    StdDev DECIMAL(10,2) NOT NULL,             -- 標準差
    SampleSize INT NOT NULL,                   -- 樣本數
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    
    CONSTRAINT FK_NormData_TraitCategory 
        FOREIGN KEY (TraitCategoryId) 
        REFERENCES dbo.TraitCategory(Id)
);
```

**方案 B: 動態計算常模**
- 從現有 TestScore 資料計算
- 需要足夠的樣本數

---

### 2. 報告模板資料🟡 建議建立

**需求來源**:
- 詳細報告頁需要各維度的分析文字
- 職涯建議需要模板

**建議方案**:

**方案 A: 建立報告模板表**
```sql
CREATE TABLE dbo.ReportTemplate (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    TraitCategoryId INT NOT NULL,
    Level NVARCHAR(20) NOT NULL,              -- Low, Medium, High
    AnalysisText NVARCHAR(MAX) NOT NULL,        -- 分析文字
    CareerAdvice NVARCHAR(MAX) NULL,           -- 職涯建議
    GrowthAdvice NVARCHAR(MAX) NULL,           -- 成長建議
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    
    CONSTRAINT FK_ReportTemplate_TraitCategory 
        FOREIGN KEY (TraitCategoryId) 
        REFERENCES dbo.TraitCategory(Id)
);
```

**方案 B: 使用 JSON 配置檔**
- 儲存在應用程式設定中
- 不存入資料庫

---

### 3. 系統設定資料🟡 建議建立

**需求來源**:
- 管理系統設定頁需要儲存設定

**建議方案**:
```sql
CREATE TABLE dbo.SystemSetting (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    SettingKey NVARCHAR(100) NOT NULL UNIQUE,  -- 設定鍵
    SettingValue NVARCHAR(MAX) NULL,           -- 設定值（可為 JSON）
    Description NVARCHAR(500) NULL,            -- 說明
    UpdatedAt DATETIME2 NOT NULL DEFAULT GETDATE()
);
```

---

## 優先順序建議

### 🔴 第一優先（必須新增）
1. **Consultation 表** - 諮詢功能核心
2. **常模資料** - 百分位計算必需

### 🟡 第二優先（建議新增）
3. **TestScore 表** - 分數查詢優化
4. **AdminUser 表** - 管理系統安全
5. **TestSession.Age 欄位** - 資料完整性
6. **TestSession.SessionCode 欄位** - 使用者體驗
7. **報告模板資料** - 報告內容生成

### 🔵 第三優先（可選新增）
8. **TestReport 表** - 報告版本管理
9. **TestPaper.Icon 欄位** - UI 美化
10. **SystemSetting 表** - 系統設定
11. **其他統計欄位** - IPAddress, UserAgent 等

---

## 實作建議

### 階段一：核心功能
1. 建立 Consultation 表
2. 建立 TestScore 表
3. 擴充 TestSession 欄位（Age, SessionCode）

### 階段二：功能完善
4. 建立 AdminUser 表
5. 建立常模資料表或計算邏輯
6. 建立報告模板資料

### 階段三：優化擴充
7. 建立 SystemSetting 表
8. 擴充其他欄位
9. 建立 TestReport 表

---

## 總結

### 必須新增
- **1 個資料表**: Consultation
- **常模資料**: 用於百分位計算

### 建議新增
- **3 個資料表**: AdminUser, TestScore, SystemSetting
- **多個欄位擴充**: TestSession, TestPaper

### 預估工作量
- **資料表建立**: 1-2 天
- **資料遷移**: 1 天
- **API 調整**: 2-3 天
- **總計**: 4-6 天

