# 新增資料表與欄位

## 必須新增的資料表

### 1. Consultation（諮詢記錄表）

```sql
-- ============================================================================
-- 表 8: Consultation（諮詢記錄表）
-- ============================================================================
-- 說明: 記錄使用者提交的諮詢請求
-- 預估筆數: 不限
-- ============================================================================

IF OBJECT_ID('dbo.Consultation', 'U') IS NOT NULL
    DROP TABLE dbo.Consultation;
GO

CREATE TABLE dbo.Consultation (
    Id INT IDENTITY(1,1) PRIMARY KEY,           -- 主鍵
    TestSessionId INT NULL,                      -- 關聯的測驗記錄ID（可選）
    Title NVARCHAR(200) NOT NULL,                -- 諮詢標題
    Category NVARCHAR(50) NOT NULL,              -- 諮詢類別：測驗結果解讀、職業發展諮詢、人際關係輔導、個人成長規劃、其他問題
    Content NVARCHAR(MAX) NOT NULL,              -- 諮詢內容
    ContactMethod NVARCHAR(20) NOT NULL,         -- 聯絡方式：Email, Phone, Line
    ContactInfo NVARCHAR(200) NULL,              -- 聯絡資訊（Email/電話/Line ID）
    AvailableTimes NVARCHAR(500) NULL,           -- 方便聯絡時間（JSON 格式：["平日上午", "平日下午"]）
    Status NVARCHAR(20) NOT NULL DEFAULT 'Pending',  -- 狀態：Pending, InProgress, Completed, Cancelled
    ReplyContent NVARCHAR(MAX) NULL,            -- 回覆內容
    RepliedBy INT NULL,                          -- 回覆人員ID（未來擴充，關聯 AdminUser）
    RepliedAt DATETIME2 NULL,                   -- 回覆時間
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),  -- 建立時間
    UpdatedAt DATETIME2 NULL,                    -- 更新時間
    
    CONSTRAINT FK_Consultation_TestSession 
        FOREIGN KEY (TestSessionId) 
        REFERENCES dbo.TestSession(Id)
);
GO

-- 建立索引
CREATE INDEX IX_Consultation_Status ON dbo.Consultation(Status);
CREATE INDEX IX_Consultation_CreatedAt ON dbo.Consultation(CreatedAt);
CREATE INDEX IX_Consultation_TestSessionId ON dbo.Consultation(TestSessionId);
GO

-- 添加中文註解
EXEC sys.sp_addextendedproperty 
    @name = N'MS_Description', @value = N'諮詢記錄表',
    @level0type = N'SCHEMA', @level0name = N'dbo',
    @level1type = N'TABLE', @level1name = N'Consultation';
GO

-- 建立 UpdatedAt 自動更新的 Trigger
CREATE TRIGGER TR_Consultation_UpdatedAt
ON dbo.Consultation
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE dbo.Consultation
    SET UpdatedAt = GETDATE()
    FROM dbo.Consultation c
    INNER JOIN inserted i ON c.Id = i.Id;
END;
GO
```

---

## 建議新增的資料表

### 2. AdminUser（管理員表）

```sql
-- ============================================================================
-- 表 9: AdminUser（管理員表）
-- ============================================================================
-- 說明: 管理系統的使用者帳號
-- 預估筆數: 5-20
-- ============================================================================

IF OBJECT_ID('dbo.AdminUser', 'U') IS NOT NULL
    DROP TABLE dbo.AdminUser;
GO

CREATE TABLE dbo.AdminUser (
    Id INT IDENTITY(1,1) PRIMARY KEY,           -- 主鍵
    Username NVARCHAR(50) NOT NULL UNIQUE,      -- 帳號
    PasswordHash NVARCHAR(256) NOT NULL,        -- 密碼雜湊（使用 BCrypt 或類似演算法）
    DisplayName NVARCHAR(100) NULL,             -- 顯示名稱
    Email NVARCHAR(100) NULL,                   -- Email
    Role NVARCHAR(20) NOT NULL DEFAULT 'Admin', -- 角色：Admin, SuperAdmin
    IsActive BIT NOT NULL DEFAULT 1,           -- 是否啟用
    LastLoginAt DATETIME2 NULL,                -- 最後登入時間
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),  -- 建立時間
    UpdatedAt DATETIME2 NULL,                   -- 更新時間
);
GO

-- 建立索引
CREATE INDEX IX_AdminUser_Username ON dbo.AdminUser(Username);
CREATE INDEX IX_AdminUser_IsActive ON dbo.AdminUser(IsActive);
GO

-- 添加中文註解
EXEC sys.sp_addextendedproperty 
    @name = N'MS_Description', @value = N'管理員表',
    @level0type = N'SCHEMA', @level0name = N'dbo',
    @level1type = N'TABLE', @level1name = N'AdminUser';
GO

-- 建立 UpdatedAt 自動更新的 Trigger
CREATE TRIGGER TR_AdminUser_UpdatedAt
ON dbo.AdminUser
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE dbo.AdminUser
    SET UpdatedAt = GETDATE()
    FROM dbo.AdminUser au
    INNER JOIN inserted i ON au.Id = i.Id;
END;
GO
```

---

### 3. TestScore（測驗分數表）

```sql
-- ============================================================================
-- 表 10: TestScore（測驗分數表）
-- ============================================================================
-- 說明: 儲存計算後的各特質分數
-- 預估筆數: 每個 TestSession 對應多個 TestScore（依特質數量）
-- ============================================================================

IF OBJECT_ID('dbo.TestScore', 'U') IS NOT NULL
    DROP TABLE dbo.TestScore;
GO

CREATE TABLE dbo.TestScore (
    Id INT IDENTITY(1,1) PRIMARY KEY,           -- 主鍵
    TestSessionId INT NOT NULL,                 -- 受測記錄ID
    TraitCategoryId INT NOT NULL,              -- 特質ID
    RawScore DECIMAL(10,2) NOT NULL,            -- 原始分數
    Percentile INT NULL,                        -- 百分位（0-100）
    Level NVARCHAR(20) NULL,                    -- 等級：Low, Medium, High
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),  -- 建立時間
    
    CONSTRAINT UQ_TestScore_SessionTrait UNIQUE (TestSessionId, TraitCategoryId),
    CONSTRAINT FK_TestScore_TestSession 
        FOREIGN KEY (TestSessionId) 
        REFERENCES dbo.TestSession(Id) 
        ON DELETE CASCADE,
    CONSTRAINT FK_TestScore_TraitCategory 
        FOREIGN KEY (TraitCategoryId) 
        REFERENCES dbo.TraitCategory(Id)
);
GO

-- 建立索引
CREATE INDEX IX_TestScore_TestSessionId ON dbo.TestScore(TestSessionId);
CREATE INDEX IX_TestScore_TraitCategoryId ON dbo.TestScore(TraitCategoryId);
GO

-- 添加中文註解
EXEC sys.sp_addextendedproperty 
    @name = N'MS_Description', @value = N'測驗分數表',
    @level0type = N'SCHEMA', @level0name = N'dbo',
    @level1type = N'TABLE', @level1name = N'TestScore';
GO
```

---

### 4. NormData（常模資料表）

```sql
-- ============================================================================
-- 表 11: NormData（常模資料表）
-- ============================================================================
-- 說明: 儲存各特質的常模資料，用於計算百分位
-- 預估筆數: 依特質數量 × 性別 × 年齡組
-- ============================================================================

IF OBJECT_ID('dbo.NormData', 'U') IS NOT NULL
    DROP TABLE dbo.NormData;
GO

CREATE TABLE dbo.NormData (
    Id INT IDENTITY(1,1) PRIMARY KEY,           -- 主鍵
    TraitCategoryId INT NOT NULL,              -- 特質ID
    Gender NVARCHAR(10) NULL,                   -- 性別：Male, Female, All（NULL 表示不分性別）
    AgeMin INT NULL,                            -- 年齡範圍最小值
    AgeMax INT NULL,                            -- 年齡範圍最大值（NULL 表示無上限）
    Mean DECIMAL(10,2) NOT NULL,                -- 平均分
    StdDev DECIMAL(10,2) NOT NULL,              -- 標準差
    SampleSize INT NOT NULL,                    -- 樣本數
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),  -- 建立時間
    UpdatedAt DATETIME2 NULL,                    -- 更新時間
    
    CONSTRAINT FK_NormData_TraitCategory 
        FOREIGN KEY (TraitCategoryId) 
        REFERENCES dbo.TraitCategory(Id)
);
GO

-- 建立索引
CREATE INDEX IX_NormData_TraitCategoryId ON dbo.NormData(TraitCategoryId);
CREATE INDEX IX_NormData_Gender_Age ON dbo.NormData(Gender, AgeMin, AgeMax);
GO

-- 添加中文註解
EXEC sys.sp_addextendedproperty 
    @name = N'MS_Description', @value = N'常模資料表',
    @level0type = N'SCHEMA', @level0name = N'dbo',
    @level1type = N'TABLE', @level1name = N'NormData';
GO
```

---

## 現有資料表需擴充的欄位

### 1. TestSession 表擴充

```sql
-- ============================================================================
-- TestSession 表欄位擴充
-- ============================================================================

-- 新增 Age 欄位
IF NOT EXISTS (SELECT * FROM sys.columns WHERE object_id = OBJECT_ID('dbo.TestSession') AND name = 'Age')
BEGIN
    ALTER TABLE dbo.TestSession
    ADD Age INT NULL;
    
    EXEC sys.sp_addextendedproperty 
        @name = N'MS_Description', @value = N'年齡',
        @level0type = N'SCHEMA', @level0name = N'dbo',
        @level1type = N'TABLE', @level1name = N'TestSession',
        @level2type = N'COLUMN', @level2name = N'Age';
END
GO

-- 新增 SessionCode 欄位（使用 GUID）
IF NOT EXISTS (SELECT * FROM sys.columns WHERE object_id = OBJECT_ID('dbo.TestSession') AND name = 'SessionCode')
BEGIN
    ALTER TABLE dbo.TestSession
    ADD SessionCode UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID();
    
    CREATE UNIQUE INDEX IX_TestSession_SessionCode ON dbo.TestSession(SessionCode);
    
    EXEC sys.sp_addextendedproperty 
        @name = N'MS_Description', @value = N'測驗編號（GUID）',
        @level0type = N'SCHEMA', @level0name = N'dbo',
        @level1type = N'TABLE', @level1name = N'TestSession',
        @level2type = N'COLUMN', @level2name = N'SessionCode';
END
GO

-- 新增 IPAddress 欄位（可選）
IF NOT EXISTS (SELECT * FROM sys.columns WHERE object_id = OBJECT_ID('dbo.TestSession') AND name = 'IPAddress')
BEGIN
    ALTER TABLE dbo.TestSession
    ADD IPAddress NVARCHAR(50) NULL;
    
    EXEC sys.sp_addextendedproperty 
        @name = N'MS_Description', @value = N'IP 位址',
        @level0type = N'SCHEMA', @level0name = N'dbo',
        @level1type = N'TABLE', @level1name = N'TestSession',
        @level2type = N'COLUMN', @level2name = N'IPAddress';
END
GO
```

---

### 2. TestPaper 表擴充

```sql
-- ============================================================================
-- TestPaper 表欄位擴充
-- ============================================================================

-- 新增 Icon 欄位
IF NOT EXISTS (SELECT * FROM sys.columns WHERE object_id = OBJECT_ID('dbo.TestPaper') AND name = 'Icon')
BEGIN
    ALTER TABLE dbo.TestPaper
    ADD Icon NVARCHAR(10) NULL;
    
    EXEC sys.sp_addextendedproperty 
        @name = N'MS_Description', @value = N'圖示（Emoji）',
        @level0type = N'SCHEMA', @level0name = N'dbo',
        @level1type = N'TABLE', @level1name = N'TestPaper',
        @level2type = N'COLUMN', @level2name = N'Icon';
END
GO

-- 新增 SortOrder 欄位
IF NOT EXISTS (SELECT * FROM sys.columns WHERE object_id = OBJECT_ID('dbo.TestPaper') AND name = 'SortOrder')
BEGIN
    ALTER TABLE dbo.TestPaper
    ADD SortOrder INT NULL DEFAULT 0;
    
    CREATE INDEX IX_TestPaper_SortOrder ON dbo.TestPaper(SortOrder, IsActive);
    
    EXEC sys.sp_addextendedproperty 
        @name = N'MS_Description', @value = N'排序順序',
        @level0type = N'SCHEMA', @level0name = N'dbo',
        @level1type = N'TABLE', @level1name = N'TestPaper',
        @level2type = N'COLUMN', @level2name = N'SortOrder';
END
GO
```

---

## 外鍵關聯更新

### Consultation 表外鍵

```sql
-- 如果 Consultation 表已建立，更新外鍵以支援 AdminUser
IF EXISTS (SELECT * FROM sys.tables WHERE name = 'Consultation')
AND EXISTS (SELECT * FROM sys.tables WHERE name = 'AdminUser')
BEGIN
    -- 檢查 RepliedBy 欄位是否存在
    IF EXISTS (SELECT * FROM sys.columns WHERE object_id = OBJECT_ID('dbo.Consultation') AND name = 'RepliedBy')
    BEGIN
        -- 如果外鍵不存在，則建立
        IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE name = 'FK_Consultation_AdminUser')
        BEGIN
            ALTER TABLE dbo.Consultation
            ADD CONSTRAINT FK_Consultation_AdminUser
                FOREIGN KEY (RepliedBy)
                REFERENCES dbo.AdminUser(Id);
        END
    END
END
GO
```

---

## 資料初始化

### AdminUser 初始資料

```sql
-- 建立預設管理員帳號（密碼：admin123，需使用 BCrypt 雜湊）
-- 注意：實際部署時應修改預設密碼
IF EXISTS (SELECT * FROM sys.tables WHERE name = 'AdminUser')
BEGIN
    IF NOT EXISTS (SELECT * FROM dbo.AdminUser WHERE Username = 'admin')
    BEGIN
        INSERT INTO dbo.AdminUser (Username, PasswordHash, DisplayName, Email, Role, IsActive)
        VALUES (
            'admin',
            '$2a$10$...', -- 需使用實際的 BCrypt 雜湊值
            '系統管理員',
            'admin@example.com',
            'SuperAdmin',
            1
        );
    END
END
GO
```

---

## 執行順序

### 建議執行順序

1. **第一階段：核心功能**
   ```sql
   -- 1. 建立 Consultation 表
   -- 2. 擴充 TestSession 欄位（Age, SessionCode）
   ```

2. **第二階段：功能完善**
   ```sql
   -- 3. 建立 AdminUser 表
   -- 4. 建立 TestScore 表
   -- 5. 擴充 TestPaper 欄位（Icon, SortOrder）
   ```

3. **第三階段：統計分析**
   ```sql
   -- 6. 建立 NormData 表
   -- 7. 匯入常模資料
   ```

---

## 驗證查詢

### 檢查新增的資料表

```sql
-- 檢查所有資料表
SELECT 
    name AS TableName,
    create_date AS CreateDate
FROM sys.tables
WHERE type = 'U'
ORDER BY name;
```

### 檢查新增的欄位

```sql
-- 檢查 TestSession 新增欄位
SELECT 
    c.name AS ColumnName,
    t.name AS DataType,
    c.max_length AS MaxLength,
    c.is_nullable AS IsNullable
FROM sys.columns c
INNER JOIN sys.types t ON c.user_type_id = t.user_type_id
WHERE c.object_id = OBJECT_ID('dbo.TestSession')
AND c.name IN ('Age', 'SessionCode', 'IPAddress')
ORDER BY c.name;
```

---

## 總結

### 新增資料表（4個）
1. ✅ Consultation - 諮詢記錄
2. ✅ AdminUser - 管理員
3. ✅ TestScore - 測驗分數
4. ✅ NormData - 常模資料

### 擴充欄位
- TestSession: Age, SessionCode, IPAddress
- TestPaper: Icon, SortOrder

### 預估執行時間
- **SQL 腳本執行**: 5-10 分鐘
- **資料遷移**: 視資料量而定
- **測試驗證**: 30 分鐘

