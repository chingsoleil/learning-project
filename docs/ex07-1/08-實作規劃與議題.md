# 實作規劃與議題

## 專案架構

### 後端架構

```
PsychometricTestAPI/
├── Controllers/          # API 控制器
│   ├── TestPapersController.cs
│   ├── TestSessionsController.cs
│   ├── TestAnswersController.cs
│   ├── ConsultationsController.cs
│   └── Admin/
│       ├── DashboardController.cs
│       ├── TestManagementController.cs
│       └── ...
├── Models/              # 資料模型
│   ├── TestPaper.cs
│   ├── TestSession.cs
│   ├── TestAnswer.cs
│   └── ...
├── Services/            # 業務邏輯
│   ├── TestService.cs
│   ├── ScoreCalculationService.cs
│   ├── ReportGenerationService.cs
│   └── ...
├── Repositories/        # 資料存取
│   ├── ITestPaperRepository.cs
│   ├── TestPaperRepository.cs
│   └── ...
├── Data/                # DbContext
│   └── PsychometricTestDbContext.cs
└── Program.cs
```

### 前端架構

```
psychometric-test-frontend/
├── src/
│   ├── views/           # 頁面組件（已建立）
│   ├── components/      # 共用組件（已建立）
│   ├── stores/          # Pinia 狀態管理
│   │   ├── test.js     # 測驗狀態（已建立）
│   │   ├── admin.js    # 管理系統狀態（需新增）
│   │   └── consultation.js  # 諮詢狀態（需新增）
│   ├── services/        # API 服務層（需新增）
│   │   ├── api.js      # API 基礎設定
│   │   ├── testPaperService.js
│   │   ├── testSessionService.js
│   │   └── ...
│   ├── router/          # 路由（已建立）
│   └── utils/           # 工具函數
│       ├── scoreCalculation.js
│       └── formatters.js
```

---

## 實作階段規劃

### 階段一：後端 API 基礎建設（5-7 天）

#### 1.1 專案建立與設定
- [ ] 建立 ASP.NET Core 10.0 Web API 專案
- [ ] 設定 EF Core 與 MSSQL 連線
- [ ] 設定 CORS
- [ ] 設定 Swagger/OpenAPI
- [ ] 設定 Logging

#### 1.2 資料模型與 DbContext
- [ ] 建立所有 Entity Models
- [ ] 建立 DbContext
- [ ] 設定 Entity Relationships
- [ ] 執行資料庫遷移

#### 1.3 Repository 層
- [ ] 建立 Repository Interface
- [ ] 實作 Repository
- [ ] 單元測試

#### 1.4 基礎 API
- [ ] TestPapers API（CRUD）
- [ ] TestPaperDetails API
- [ ] TestSessions API（建立、查詢）
- [ ] TestAnswers API（建立、查詢）

**預估時間**: 5-7 天

---

### 階段二：核心功能實作（7-10 天）

#### 2.1 測驗流程 API
- [ ] 取得測卷列表 API
- [ ] 取得測卷題目 API（依 QuestionOrder 排序）
- [ ] 建立測驗記錄 API
- [ ] 儲存作答記錄 API
- [ ] 完成測驗 API

#### 2.2 分數計算服務
- [ ] 實作分數計算邏輯
  - 正反向計分處理（ScoringKey）
  - 依 TraitCategoryId 分組
  - 計算原始分數
- [ ] 實作百分位計算
  - 使用常模資料或動態計算
- [ ] 實作等級判定（Low/Medium/High）

#### 2.3 測驗結果 API
- [ ] 取得測驗結果 API
- [ ] 取得詳細報告 API
- [ ] 儲存 TestScore 記錄

#### 2.4 歷史記錄 API
- [ ] 依 Email + Phone 查詢 API
- [ ] 驗證邏輯

**預估時間**: 7-10 天

---

### 階段三：前端 API 整合（5-7 天）

#### 3.1 API 服務層
- [ ] 建立 API 基礎設定（axios 或 fetch）
- [ ] 建立各模組 Service
- [ ] 錯誤處理
- [ ] Loading 狀態管理

#### 3.2 頁面 API 整合
- [ ] 首頁：動態載入測卷列表
- [ ] 測驗介紹頁：動態載入測卷資訊
- [ ] 答題頁：動態載入題目
- [ ] 結果頁：動態載入結果
- [ ] 詳細報告頁：動態載入報告
- [ ] 歷史記錄頁：查詢 API

#### 3.3 狀態管理調整
- [ ] 移除靜態 JSON 資料
- [ ] 改為從 API 載入
- [ ] 更新 Pinia Store

**預估時間**: 5-7 天

---

### 階段四：管理系統實作（7-10 天）

#### 4.1 管理員認證
- [ ] JWT 或 Session 認證
- [ ] 登入 API
- [ ] 權限控制
- [ ] 路由守衛

#### 4.2 管理系統 API
- [ ] 儀表板統計 API
- [ ] 測驗管理 API（CRUD）
- [ ] 題目管理 API
- [ ] 使用者管理 API
- [ ] 諮詢管理 API
- [ ] 報告管理 API

#### 4.3 管理系統前端整合
- [ ] 登入頁 API 整合
- [ ] 儀表板 API 整合
- [ ] 各管理頁面 API 整合

**預估時間**: 7-10 天

---

### 階段五：諮詢功能實作（3-5 天）

#### 5.1 諮詢 API
- [ ] 建立諮詢記錄 API
- [ ] 查詢諮詢列表 API
- [ ] 更新諮詢狀態 API
- [ ] 回覆諮詢 API

#### 5.2 諮詢前端整合
- [ ] 詳細報告頁諮詢表單提交
- [ ] 管理系統諮詢管理頁

**預估時間**: 3-5 天

---

### 階段六：優化與測試（5-7 天）

#### 6.1 效能優化
- [ ] 查詢優化（索引檢查）
- [ ] 快取機制（Redis 可選）
- [ ] API 回應時間優化

#### 6.2 功能完善
- [ ] 時間限制功能
- [ ] PDF 下載功能
- [ ] 分享功能
- [ ] 錯誤處理完善

#### 6.3 測試
- [ ] 單元測試
- [ ] 整合測試
- [ ] E2E 測試
- [ ] 效能測試

**預估時間**: 5-7 天

---

## 技術議題討論

### 1. 認證與授權

**議題**: 如何實作管理系統認證？

**選項 A: JWT Token**
- 優點：無狀態、易於擴充、支援多端
- 缺點：Token 過期處理、無法即時撤銷
- 建議：✅ 採用

**選項 B: Session**
- 優點：易於撤銷、伺服器端控制
- 缺點：需儲存 Session、擴充性較差
- 建議：不採用

**實作建議**:
```csharp
// 使用 JWT + Refresh Token
services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options => { ... });
```

---

### 2. 分數計算時機

**議題**: 何時計算分數？

**選項 A: 即時計算**
- 完成測驗時立即計算
- 儲存到 TestScore 表
- 優點：查詢快速、資料一致
- 建議：✅ 採用

**選項 B: 查詢時計算**
- 每次查詢時動態計算
- 優點：節省儲存空間
- 缺點：查詢慢、可能不一致
- 建議：不採用

**實作建議**:
```csharp
// 完成測驗時
public async Task<TestResult> CompleteTest(int sessionId)
{
    // 1. 計算分數
    var scores = await CalculateScores(sessionId);
    
    // 2. 儲存到 TestScore
    await SaveScores(sessionId, scores);
    
    // 3. 更新 TestSession 狀態
    await UpdateSessionStatus(sessionId, "Completed");
    
    // 4. 回傳結果
    return BuildTestResult(sessionId, scores);
}
```

---

### 3. 百分位計算方式

**議題**: 如何計算百分位？

**選項 A: 使用常模資料表**
- 預先建立 NormData 表
- 依性別、年齡查詢對應常模
- 使用 Z-score 計算百分位
- 優點：準確、快速
- 建議：✅ 採用（長期）

**選項 B: 動態計算**
- 從現有 TestScore 資料計算
- 統計所有使用者的分數分布
- 優點：不需要預先建立常模
- 缺點：需要足夠樣本、計算較慢
- 建議：採用（短期，樣本不足時）

**實作建議**:
```csharp
// 優先使用常模，樣本不足時使用動態計算
public async Task<int> CalculatePercentile(int traitId, decimal rawScore, string gender, int age)
{
    // 1. 嘗試查詢常模
    var norm = await GetNormData(traitId, gender, age);
    if (norm != null && norm.SampleSize >= 100)
    {
        return CalculatePercentileFromNorm(rawScore, norm);
    }
    
    // 2. 動態計算
    return await CalculatePercentileFromData(traitId, rawScore);
}
```

---

### 4. 報告內容生成

**議題**: 如何生成報告內容？

**選項 A: 模板系統**
- 建立 ReportTemplate 表
- 依特質、等級查詢對應模板
- 動態組合報告內容
- 優點：易於維護、可客製化
- 建議：✅ 採用

**選項 B: 硬編碼邏輯**
- 在程式碼中寫死邏輯
- 優點：簡單快速
- 缺點：不易維護、無法客製化
- 建議：不採用

**實作建議**:
```csharp
public async Task<DetailedReport> GenerateReport(int sessionId)
{
    var scores = await GetTestScores(sessionId);
    var report = new DetailedReport();
    
    foreach (var score in scores)
    {
        var template = await GetReportTemplate(score.TraitCategoryId, score.Level);
        report.Dimensions.Add(new DimensionAnalysis
        {
            Trait = score.Trait,
            Score = score,
            Analysis = template.AnalysisText,
            CareerAdvice = template.CareerAdvice,
            GrowthAdvice = template.GrowthAdvice
        });
    }
    
    return report;
}
```

---

### 5. 資料遷移策略

**議題**: 如何處理現有資料？

**選項 A: EF Core Migrations**
- 使用 Code First Migrations
- 自動生成遷移腳本
- 優點：版本控制、可回滾
- 建議：✅ 採用

**選項 B: 手動 SQL 腳本**
- 手動編寫 SQL
- 優點：完全控制
- 缺點：不易維護
- 建議：不採用（除非特殊需求）

---

### 6. API 版本控制

**議題**: 是否需要 API 版本控制？

**建議**: 
- 初期不需要，但保留擴充空間
- 可在 URL 中加入版本：`/api/v1/testpapers`
- 或使用 Header：`Api-Version: 1.0`

---

### 7. 錯誤處理策略

**建議**:
```csharp
// 統一錯誤回應格式
public class ApiResponse<T>
{
    public bool Success { get; set; }
    public T Data { get; set; }
    public string Message { get; set; }
    public List<string> Errors { get; set; }
}

// 使用 Exception Filter 統一處理
public class ApiExceptionFilter : IExceptionFilter
{
    public void OnException(ExceptionContext context)
    {
        // 統一錯誤處理邏輯
    }
}
```

---

### 8. 快取策略

**建議**:
- **測卷列表**: 快取 1 小時（不常變動）
- **題目內容**: 快取 1 天（不常變動）
- **測驗結果**: 不快取（個人資料）
- **統計資料**: 快取 5 分鐘（儀表板）

---

## 風險與挑戰

### 技術風險

1. **分數計算複雜度**
   - 風險：不同測卷可能有不同計算邏輯
   - 對策：建立可擴充的計算服務

2. **效能問題**
   - 風險：大量查詢可能影響效能
   - 對策：適當的索引、快取、分頁

3. **資料一致性**
   - 風險：並發寫入可能造成資料不一致
   - 對策：使用 Transaction、樂觀鎖

### 業務風險

1. **常模資料不足**
   - 風險：初期樣本數不足，百分位不準確
   - 對策：使用動態計算，累積樣本後建立常模

2. **報告內容品質**
   - 風險：報告模板需要專業知識
   - 對策：與心理學專家合作建立模板

---

## 總結

### 總預估時間
- **階段一**: 5-7 天
- **階段二**: 7-10 天
- **階段三**: 5-7 天
- **階段四**: 7-10 天
- **階段五**: 3-5 天
- **階段六**: 5-7 天
- **總計**: 32-46 天（約 6-9 週）

### 關鍵決策
1. ✅ 使用 JWT 認證
2. ✅ 即時計算並儲存分數
3. ✅ 使用常模資料表（長期）+ 動態計算（短期）
4. ✅ 使用模板系統生成報告
5. ✅ 使用 EF Core Migrations

### 下一步行動
1. 建立後端專案結構
2. 建立資料模型
3. 實作基礎 API
4. 前端 API 整合

