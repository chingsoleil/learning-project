<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»˜æ¬¾ - é»é¤ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    maxWidth: {
                        'mobile': '480px'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-sans">
    <!-- ä¸»å®¹å™¨ -->
    <div class="mx-auto max-w-mobile min-h-screen bg-white shadow-lg">
        <!-- æ¨™é¡Œåˆ— -->
        <header class="bg-blue-600 text-white p-4">
            <h1 class="text-lg font-semibold">ä»˜æ¬¾</h1>
            <div class="text-sm mt-1 opacity-90">æ­¥é©Ÿ 8/9 Â· å°åŒ—ä¿¡ç¾©åº— Â· å¤–å¸¶</div>
        </header>

        <!-- é€²åº¦æ¢ -->
        <div class="bg-gray-200 h-2">
            <div class="bg-blue-600 h-2 transition-all duration-300" style="width: 88.8%"></div>
        </div>

        <!-- å…§å®¹å€ -->
        <main class="pb-20">
            <!-- æ‡‰ä»˜é‡‘é¡ -->
            <div class="p-4 border-b border-gray-200">
                <div class="text-center py-6">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-2">æ‡‰ä»˜é‡‘é¡</h2>
                    <div class="text-4xl font-bold text-blue-600" id="payableAmount">$200</div>
                    <p class="text-sm text-gray-500 mt-2">æ–°å°å¹£</p>
                </div>
            </div>

            <!-- ä»˜æ¬¾æ–¹å¼é¸æ“‡ -->
            <div class="p-4">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">é¸æ“‡ä»˜æ¬¾æ–¹å¼ <span class="text-red-500">*</span></h2>
                
                <div class="space-y-3">
                    <!-- ç¾é‡‘ä»˜æ¬¾ -->
                    <label class="block">
                        <input type="radio" name="paymentMethod" value="CASH" class="sr-only" onchange="selectPaymentMethod('CASH')">
                        <div class="border-2 border-blue-500 bg-blue-50 rounded-lg p-4 cursor-pointer hover:border-blue-600 transition-all" id="payment-CASH">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-6 h-6 border-2 border-blue-600 rounded-full mr-3 flex items-center justify-center">
                                        <div class="w-3 h-3 bg-blue-600 rounded-full"></div>
                                    </div>
                                    <div>
                                        <h3 class="font-medium text-gray-900">ç¾é‡‘ä»˜æ¬¾</h3>
                                        <p class="text-sm text-gray-600">å–é¤æ™‚ç¾å ´ä»˜æ¬¾</p>
                                    </div>
                                </div>
                                <div class="text-3xl">ğŸ’µ</div>
                            </div>
                        </div>
                    </label>

                    <!-- ä¿¡ç”¨å¡ä»˜æ¬¾ -->
                    <label class="block">
                        <input type="radio" name="paymentMethod" value="CARD" class="sr-only" onchange="selectPaymentMethod('CARD')">
                        <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all" id="payment-CARD">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-6 h-6 border-2 border-gray-300 rounded-full mr-3 flex items-center justify-center">
                                        <div class="w-3 h-3 bg-blue-600 rounded-full hidden"></div>
                                    </div>
                                    <div>
                                        <h3 class="font-medium text-gray-900">ä¿¡ç”¨å¡ä»˜æ¬¾</h3>
                                        <p class="text-sm text-gray-600">ç·šä¸Šå®‰å…¨ä»˜æ¬¾</p>
                                    </div>
                                </div>
                                <div class="text-3xl">ğŸ’³</div>
                            </div>
                        </div>
                    </label>

                    <!-- é›»å­éŒ¢åŒ… -->
                    <label class="block">
                        <input type="radio" name="paymentMethod" value="E_WALLET" class="sr-only" onchange="selectPaymentMethod('E_WALLET')">
                        <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all" id="payment-E_WALLET">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-6 h-6 border-2 border-gray-300 rounded-full mr-3 flex items-center justify-center">
                                        <div class="w-3 h-3 bg-blue-600 rounded-full hidden"></div>
                                    </div>
                                    <div>
                                        <h3 class="font-medium text-gray-900">é›»å­éŒ¢åŒ…</h3>
                                        <p class="text-sm text-gray-600">LINE Pay / è¡—å£æ”¯ä»˜</p>
                                    </div>
                                </div>
                                <div class="text-3xl">ğŸ“±</div>
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- æ”¯ä»˜æä¾›å•†é¸æ“‡ -->
            <div class="px-4 pb-4 hidden" id="paymentProviderSection">
                <h3 class="text-lg font-medium text-gray-900 mb-3">é¸æ“‡æ”¯ä»˜æœå‹™</h3>
                <div class="grid grid-cols-2 gap-3" id="providerOptions">
                    <!-- å‹•æ…‹ç”¢ç”Ÿ -->
                </div>
            </div>

            <!-- ç¾é‡‘ä»˜æ¬¾èªªæ˜ -->
            <div class="px-4 pb-4" id="cashPaymentInfo">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="flex">
                        <div class="text-yellow-600 mr-2">â„¹ï¸</div>
                        <div>
                            <h3 class="font-medium text-yellow-800">ç¾é‡‘ä»˜æ¬¾èªªæ˜</h3>
                            <p class="text-sm text-yellow-700 mt-1">è«‹æ–¼å–é¤æ™‚æº–å‚™ç¾é‡‘ï¼Œå»ºè­°æº–å‚™é›¶éŒ¢ä»¥åŠ å¿«å–é¤é€Ÿåº¦</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä»˜æ¬¾å®‰å…¨èªªæ˜ -->
            <div class="px-4 pb-4 hidden" id="onlinePaymentInfo">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex">
                        <div class="text-green-600 mr-2">ğŸ”’</div>
                        <div>
                            <h3 class="font-medium text-green-800">å®‰å…¨ä»˜æ¬¾ä¿éšœ</h3>
                            <p class="text-sm text-green-700 mt-1">æ¡ç”¨ SSL åŠ å¯†æŠ€è¡“ä¿è­·æ‚¨çš„ä»˜æ¬¾è³‡è¨Šï¼Œäº¤æ˜“å®‰å…¨æœ‰ä¿éšœ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¨‚å–®æ‘˜è¦ -->
            <div class="px-4 pb-4">
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">è¨‚å–®æ‘˜è¦</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">å–è²¨é–€å¸‚</span>
                            <span class="font-medium">å°åŒ—ä¿¡ç¾©åº—</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">å–é¤æ™‚é–“</span>
                            <span class="font-medium" id="pickupTime">ç«‹å³å–é¤</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">ç”¨é¤æ–¹å¼</span>
                            <span class="font-medium">å¤–å¸¶</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">é¤é»å°è¨ˆ</span>
                            <span class="font-medium" id="itemsSubtotal">$200</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">åŒ…è£è²»</span>
                            <span class="font-medium" id="packagingFee">$0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">æŠ˜æ‰£</span>
                            <span class="font-medium text-green-600" id="discount">-$0</span>
                        </div>
                        <div class="border-t border-gray-300 pt-2 mt-2">
                            <div class="flex justify-between">
                                <span class="text-lg font-semibold text-gray-900">æ‡‰ä»˜ç¸½é¡</span>
                                <span class="text-lg font-bold text-blue-600" id="grandTotal">$200</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- åº•éƒ¨å°è¦½ -->
        <footer class="fixed bottom-0 left-1/2 transform -translate-x-1/2 w-full max-w-mobile bg-white border-t border-gray-200 p-4">
            <div class="flex gap-3">
                <button class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors" onclick="goBack()">
                    è¿”å›
                </button>
                <button class="flex-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors" onclick="processPayment()">
                    <span id="paymentButtonText">ç¢ºèªä»˜æ¬¾</span>
                </button>
                <button class="px-4 py-3 text-blue-600 border border-blue-600 rounded-lg hover:bg-blue-50 transition-colors" onclick="goToStoreSelect()">
                    ğŸ 
                </button>
            </div>
        </footer>
    </div>

    <script>
        let selectedPaymentMethod = 'CASH';
        let selectedProvider = null;
        let orderSummary = {};
        let pickupInfo = {};

        // åˆå§‹åŒ–é é¢
        document.addEventListener('DOMContentLoaded', function() {
            loadOrderData();
            updateOrderSummary();
            updatePaymentButton();
        });

        function loadOrderData() {
            orderSummary = JSON.parse(sessionStorage.getItem('orderSummary') || '{"grandTotal":200}');
            pickupInfo = JSON.parse(sessionStorage.getItem('pickupInfo') || '{}');
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            selectedProvider = null;

            // é‡ç½®æ‰€æœ‰ä»˜æ¬¾æ–¹å¼æ¨£å¼
            document.querySelectorAll('[id^="payment-"]').forEach(option => {
                option.classList.remove('border-blue-500', 'bg-blue-50');
                option.classList.add('border-gray-200');
                
                const radio = option.querySelector('.w-6 > div');
                const radioContainer = option.querySelector('.w-6');
                radio.classList.add('hidden');
                radioContainer.classList.remove('border-blue-600');
                radioContainer.classList.add('border-gray-300');
            });

            // è¨­å®šé¸ä¸­æ¨£å¼
            const selectedOption = document.getElementById(`payment-${method}`);
            selectedOption.classList.remove('border-gray-200');
            selectedOption.classList.add('border-blue-500', 'bg-blue-50');
            
            const selectedRadio = selectedOption.querySelector('.w-6 > div');
            const selectedRadioContainer = selectedOption.querySelector('.w-6');
            selectedRadio.classList.remove('hidden');
            selectedRadioContainer.classList.remove('border-gray-300');
            selectedRadioContainer.classList.add('border-blue-600');

            // é¡¯ç¤º/éš±è—ç›¸é—œå€å¡Š
            updatePaymentSections(method);
            updatePaymentButton();
        }

        function updatePaymentSections(method) {
            const providerSection = document.getElementById('paymentProviderSection');
            const cashInfo = document.getElementById('cashPaymentInfo');
            const onlineInfo = document.getElementById('onlinePaymentInfo');

            // éš±è—æ‰€æœ‰å€å¡Š
            providerSection.classList.add('hidden');
            cashInfo.classList.add('hidden');
            onlineInfo.classList.add('hidden');

            if (method === 'CASH') {
                cashInfo.classList.remove('hidden');
            } else if (method === 'CARD') {
                onlineInfo.classList.remove('hidden');
                providerSection.classList.remove('hidden');
                showCardProviders();
            } else if (method === 'E_WALLET') {
                onlineInfo.classList.remove('hidden');
                providerSection.classList.remove('hidden');
                showEWalletProviders();
            }
        }

        function showCardProviders() {
            const providerOptions = document.getElementById('providerOptions');
            providerOptions.innerHTML = `
                <button class="p-4 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all text-center" onclick="selectProvider('Visa')">
                    <div class="text-2xl mb-2">ğŸ’³</div>
                    <div class="text-sm font-medium">Visa</div>
                </button>
                <button class="p-4 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all text-center" onclick="selectProvider('MasterCard')">
                    <div class="text-2xl mb-2">ğŸ’³</div>
                    <div class="text-sm font-medium">MasterCard</div>
                </button>
                <button class="p-4 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all text-center" onclick="selectProvider('JCB')">
                    <div class="text-2xl mb-2">ğŸ’³</div>
                    <div class="text-sm font-medium">JCB</div>
                </button>
                <button class="p-4 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all text-center" onclick="selectProvider('UnionPay')">
                    <div class="text-2xl mb-2">ğŸ’³</div>
                    <div class="text-sm font-medium">éŠ€è¯å¡</div>
                </button>
            `;
        }

        function showEWalletProviders() {
            const providerOptions = document.getElementById('providerOptions');
            providerOptions.innerHTML = `
                <button class="p-4 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all text-center" onclick="selectProvider('LinePay')">
                    <div class="text-2xl mb-2">ğŸ’š</div>
                    <div class="text-sm font-medium">LINE Pay</div>
                </button>
                <button class="p-4 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all text-center" onclick="selectProvider('JKOPay')">
                    <div class="text-2xl mb-2">ğŸŸ¡</div>
                    <div class="text-sm font-medium">è¡—å£æ”¯ä»˜</div>
                </button>
                <button class="p-4 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all text-center" onclick="selectProvider('ApplePay')">
                    <div class="text-2xl mb-2">ğŸ</div>
                    <div class="text-sm font-medium">Apple Pay</div>
                </button>
                <button class="p-4 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all text-center" onclick="selectProvider('GooglePay')">
                    <div class="text-2xl mb-2">ğŸ¨</div>
                    <div class="text-sm font-medium">Google Pay</div>
                </button>
            `;
        }

        function selectProvider(provider) {
            selectedProvider = provider;
            
            // é‡ç½®æ‰€æœ‰æä¾›å•†æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('#providerOptions button').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                btn.classList.add('border-gray-300');
            });

            // è¨­å®šé¸ä¸­æ¨£å¼
            event.target.classList.remove('border-gray-300');
            event.target.classList.add('border-blue-500', 'bg-blue-50');

            updatePaymentButton();
        }

        function updatePaymentButton() {
            const buttonText = document.getElementById('paymentButtonText');
            
            if (selectedPaymentMethod === 'CASH') {
                buttonText.textContent = 'ç¢ºèªè¨‚å–®';
            } else if (selectedPaymentMethod === 'CARD' || selectedPaymentMethod === 'E_WALLET') {
                if (selectedProvider) {
                    buttonText.textContent = `ä½¿ç”¨ ${selectedProvider} ä»˜æ¬¾`;
                } else {
                    buttonText.textContent = 'è«‹é¸æ“‡ä»˜æ¬¾æœå‹™';
                }
            }
        }

        function updateOrderSummary() {
            const total = orderSummary.grandTotal || 200;
            const subtotal = orderSummary.subtotal || 200;
            const packaging = orderSummary.packagingFee || 0;
            const discount = orderSummary.discountTotal || 0;

            document.getElementById('payableAmount').textContent = `$${total}`;
            document.getElementById('itemsSubtotal').textContent = `$${subtotal}`;
            document.getElementById('packagingFee').textContent = `$${packaging}`;
            document.getElementById('discount').textContent = discount > 0 ? `-$${discount}` : '$0';
            document.getElementById('grandTotal').textContent = `$${total}`;

            // æ›´æ–°å–é¤æ™‚é–“
            if (pickupInfo.pickupType === 'now') {
                document.getElementById('pickupTime').textContent = 'ç«‹å³å–é¤';
            } else if (pickupInfo.pickupAt) {
                const time = new Date(pickupInfo.pickupAt).toLocaleTimeString('zh-TW', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                });
                document.getElementById('pickupTime').textContent = `é ç´„å–é¤ (${time})`;
            }
        }

        function processPayment() {
            // é©—è­‰ä»˜æ¬¾æ–¹å¼
            if ((selectedPaymentMethod === 'CARD' || selectedPaymentMethod === 'E_WALLET') && !selectedProvider) {
                alert('è«‹é¸æ“‡ä»˜æ¬¾æœå‹™æä¾›å•†');
                return;
            }

            // ç”¢ç”Ÿæ¨¡æ“¬è¨‚å–®è™Ÿ
            const orderNumber = 'ORD' + new Date().toISOString().slice(0, 10).replace(/-/g, '') + 
                               String(Math.floor(Math.random() * 10000)).padStart(4, '0');
            const pickupNumber = 'P' + String(Math.floor(Math.random() * 10000)).padStart(4, '0');

            // å„²å­˜ä»˜æ¬¾è³‡è¨Š
            const paymentInfo = {
                paymentMethod: selectedPaymentMethod,
                paymentProvider: selectedProvider,
                payableAmount: orderSummary.grandTotal || 200,
                currency: 'TWD',
                transactionId: selectedPaymentMethod !== 'CASH' ? 'TXN' + Date.now() : null,
                paymentStatus: selectedPaymentMethod === 'CASH' ? 'PENDING' : 'PAID',
                paidAt: selectedPaymentMethod === 'CASH' ? null : new Date().toISOString()
            };

            const finalOrder = {
                orderNumber: orderNumber,
                pickupNumber: pickupNumber,
                orderStatus: 'RECEIVED',
                createdAt: new Date().toISOString(),
                eta: new Date(Date.now() + 15 * 60 * 1000).toISOString() // 15åˆ†é˜å¾Œ
            };

            sessionStorage.setItem('paymentInfo', JSON.stringify(paymentInfo));
            sessionStorage.setItem('finalOrder', JSON.stringify(finalOrder));

            // ä»˜æ¬¾è™•ç†å‹•ç•«
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'è™•ç†ä¸­...';
            button.classList.add('bg-gray-400');
            button.classList.remove('bg-blue-600');

            setTimeout(() => {
                window.location.href = 'order-tracking.html';
            }, 2000);
        }

        function goBack() {
            window.location.href = 'pickup.html';
        }

        function goToStoreSelect() {
            window.location.href = 'store-select.html';
        }
    </script>
</body>
</html>
